name: DerpFest Polaris Automated Build

on:
  schedule:
    - cron: "0 */12 * * *"  # 每12小时检查一次更新
  workflow_dispatch:        # 这行确保手动触发按钮存在

jobs:
  check-upstream:
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.check.outputs.changed }}
      latest_sha: ${{ steps.check.outputs.latest_sha }}

    steps:
    - name: Check Latest Commit
      id: check
      run: |
        LATEST=$(curl -s https://api.github.com/repos/LineageOS/android_device_xiaomi_polaris/commits | jq -r '.[0].sha')
        echo "latest_sha=$LATEST" >> $GITHUB_OUTPUT
        
        if [ -f LAST_SHA ] && [ "$LATEST" == "$(cat LAST_SHA)" ]; then
            echo "changed=false" >> $GITHUB_OUTPUT
        else
            echo "$LATEST" > LAST_SHA
            echo "changed=true" >> $GITHUB_OUTPUT
        fi

    - name: Save SHA
      uses: actions/upload-artifact@v4
      with:
        name: sha-record
        path: LAST_SHA

  build:
    needs: check-upstream
    if: needs.check-upstream.outputs.changed == 'true'
    runs-on: ubuntu-22.04

    steps:
    - name: Download SHA
      uses: actions/download-artifact@v4
      with:
        name: sha-record

    - name: Install env
      run: |
        sudo apt update
        sudo apt install -y repo git-core gnupg flex bison build-essential \
          zip curl zlib1g-dev gcc-multilib g++-multilib python-is-python3 \
          libncurses5 libssl-dev ccache libxml2-utils rsync openjdk-17-jdk \
          imagemagick jq libxml2-utils  # 添加 xmllint

    - name: Install latest repo
      run: |
        sudo wget https://storage.googleapis.com/git-repo-downloads/repo -O /usr/bin/repo
        sudo chmod a+x /usr/bin/repo

    - name: Initialize ROM source
      run: |
        mkdir -p ~/derpfest
        cd ~/derpfest
        repo init -u https://github.com/DerpFest-AOSP/android_manifest.git -b 16 --git-lfs

    - name: Create Polaris manifest from dependencies
      run: |
        mkdir -p ~/derpfest/.repo/local_manifests
        
        # 下载并转换依赖文件
        curl -L https://raw.githubusercontent.com/LineageOS/android_device_xiaomi_polaris/lineage-23.0/lineage.dependencies -o dependencies.json
        
        # 使用更安全的方式创建XML文件
        {
          echo '<?xml version="1.0" encoding="UTF-8"?>'
          echo '<manifest>'
          jq -r '.[] | "  <project path=\"\(.target_path)\" name=\"\(.repository)\" remote=\"github\" revision=\"\(.branch)\" />"' dependencies.json
          echo '</manifest>'
        } > ~/derpfest/.repo/local_manifests/polaris.xml
        
        # 验证并显示结果
        xmllint --noout ~/derpfest/.repo/local_manifests/polaris.xml && echo "XML验证成功"
        echo "=== 生成的manifest ==="
        cat ~/derpfest/.repo/local_manifests/polaris.xml

    - name: Sync sources
      run: |
        cd ~/derpfest
        repo sync -c -j$(nproc --all) --force-sync --no-clone-bundle --no-tags

    - name: Build DerpFest
      run: |
        cd ~/derpfest
        source build/envsetup.sh
        lunch derp_polaris-userdebug  # 修正为 DerpFest 的设备配置
        mka derp -j$(nproc)

    - name: Upload Release Artifact
      uses: actions/upload-artifact@v4
      with:
        name: DerpFest-auto-nightly
        path: ~/derpfest/out/target/product/polaris/*.zip  # 只上传 zip 文件
